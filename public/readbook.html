<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>阅读小说</title>
	<script src="./javascripts/jquery.min.js"></script>
	<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			border-style: none;
			list-style: none;
		}

		.clearfix:after,
		.clearfix:before {
			content: "";
			display: table;
		}

		.clearfix:after {
			clear: both;
		}

		.rendhead {
			width: 100%;
			height: 50px;
			background-color: orange;
		}

		.rendhead span {
			line-height: 50px;
			font-size: 20px;
		}

		.readmain {
			width: 100%;
			min-height: 500px;
		}
	</style>
</head>

<body>

	<!-- 头部 -->
	<div class="head" style="background:#5555554d;width: 100%;height: 70px;">
		<div class="container">
			<div class="logo" style="width: 70px;height: 70px;display: inline-block;">
				<img src="http://c-shuqi.11222.cn/assets/logo_7a44de2.png" alt="" style="width: 100%;height: 100%;">
			</div>
			<!--登录注册-->
			<div id="log"
				style="float: right;width: 100px;height: 70px;line-height: 70px;text-align: center;font-size: 20px;">
				<span data-toggle="modal" data-target="#login" class="login">登录</span> /
				<span data-toggle="modal" data-target="#logup" class="logup">注册</span>
			</div>
			<!--头像-->
			<div id="myimg" style="float: right;width: 70px;height: 70px;display: none;position: relative;">
				<img src=""
					alt="" id="imgs" style="width: 70px;height: 70px;border-radius: 50%;" />
				<div id="div"
					style="width: 130px;height: 110px;background: #aaa;text-align: center;line-height: 30px;display: none;margin-left: -20px;position: absolute;left: 0;bottom: -110px;z-index: 10;">
					<p style="border-bottom: 1px dotted #fff;">
						<a href="booklist.html" style="text-decoration: none;color: #fff;">书架</a>
					</p>
					<p style="border-bottom: 1px dotted #fff;">
						<a href="mymsg.html" style="text-decoration: none;color: #fff;">个人中心</a>
					</p>
					<p style="border-bottom: 1px dotted #fff; color: #fff;" id="btn_out">退出登录</p>
				</div>
			</div>

			<!--头像结束-->
		</div>
	</div>
	<!-- 头部结束 -->
	<!-- 内容 -->
	<div class="container clearfix" style="border:1px solid red;padding: 0;overflow: hidden;">
		<!-- 返回、第几章名字、章节 -->
		<div class="rendhead" style="text-align: center;">
			<span class="fh" style="float: left;display: inline-block;width: 100px;height: 100%;">返回</span>
			<span class="item_name" style="display: inline-block;width: 100px;height: 100%;">第几章xxxx</span>
			<span class="zj" style="float: right;display: inline-block;width: 100px;height: 100%;">章节</span>
		</div>
		<!-- 阅读内容 -->
		<div class="readmain">

		</div>
		<!-- 章节列表 -->
		<div class="zj_list clearfix"
			style="width: 200px;min-height: 200px;background:red;float:right;transform: translateX(200px);margin-top: -500px;">
			<ul class="r-list">

			</ul>
			<button class="zjback" style="position:fixed;bottom:0;right:0;padding: 3px 5px;">返回阅读</button>
		</div>
	</div>
	<!-- 内容结束 -->
	<!-- 尾部 -->
	<div class="foot"
		style="width: 100%;height:100px;background:#333;color: #fff;text-align: center;padding-top: 10px;">
		<div class="container">
			<p>海量图书，更高品质阅读体验</p>
			<p>网络文化经营许可证：粤网文[2017]3018-499号</p>
			<p>Designed and built with all the love in the world by @mdo and @fat. Maintained by the core team with the
				help of our contributors.</p>
		</div>
	</div>
	<!-- 尾部结束 -->
	<!--注册-->
	<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="logup">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">注册</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="img">头像
							<input style="display:none;" type="file" class="files" id="img">
							<div id="img"><img class="img" src="" alt=""></div>
						</label>
					</div>
					<div class="form-group">
						<label for="name">昵称</label>
						<input type="text" class="form-control" id="name_up" placeholder="昵称">
					</div>
					<div class="form-group">
						<label for="user">账号</label>
						<input type="text" class="form-control" id="user_up" placeholder="账号">
					</div>
					<div class="form-group">
						<label for="pass">密码</label>
						<input type="password" class="form-control" id="pass_up" placeholder="密码">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="btn_up">确定</button>
				</div>
			</div>
		</div>
	</div>
	<!--结束-->
	<!--登录-->
	<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="login">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">登录</h4>
				</div>
				<div class="modal-body">

					<div class="form-group">
						<label for="user">账号</label>
						<input type="text" class="form-control" id="user_in" placeholder="账号">
					</div>
					<div class="form-group">
						<label for="pass">密码</label>
						<input type="password" class="form-control" id="pass_in" placeholder="密码">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="btn_in">确定</button>
				</div>
			</div>
		</div>
	</div>
	<!--结束-->


	<script>
		var href = 'http://192.168.43.239:8000';
		//获取登录状态
		if (localStorage.user) {
			// console.log(123);
			var json = JSON.parse(localStorage.user);
			$("#imgs").attr("src", json.img);
			log.style.display = 'none';
			myimg.style.display = 'block';
		}
		if (localStorage.user == "" || localStorage.bookmsg == "") {
			alert("当前没有书籍信息,即将返回首页");
			location.href = "index.html";
		}
		if (localStorage.read) {
			creatcontent(JSON.parse(localStorage.read).uid);
		}
		// 点击章节，滑出章节列表
		$('.zj').on('click', function () {
			$.ajax({
				url: href + "/chaplist",
				type: "get",
				data: {
					mybook: JSON.parse(localStorage.bookmsg).uid,
				},
				success(data) {
					$(".r-list").empty();
					$.each(data, function (i, o) {
						var li = $(`<li style="width:100%;height:30px;text-align:center;line-height:30px;border-bottom:1px solid #ccc;">${o.name}</li>`);
						$(".r-list").append(li);
						$(li).on("click", function () {
							localStorage.read=JSON.stringify(o);
							creatcontent(o.uid);
						})
					})
				}
			})
			$('.zj_list').css({
				transition: '.3s',
				transform: 'translateX(0)',
			})
		})
		function creatcontent(uid) {
			$.ajax({
				url: href + '/read',
				type: "get",
				data: {
					chapid: uid
				},
				success(data) {
					// console.log(data instanceof Array)
					if (data.length!=0) {
						$(".item_name").html(JSON.parse(localStorage.read).name)
						$(".readmain").html(data[0].text);
					}else{
						alert("此章节没内容");
					}

				}
			})
		}
		// 点击返回阅读，章节列表退出
		$('.zjback').on('click', function () {
			$('.zj_list').css({
				transition: '.3s',
				transform: 'translateX(200px)',
			})
		})
		//头像
		var imgurl = '';
		$(".files").on("change", function () {
			var files = $(this)[0].files[0];
			var d = new FormData;
			d.append("tx", files);
			$.ajax({
				url: href + "/cover/cover",
				type: "post",
				data: d,
				contentType: false,
				processData: false,
				success(data) {
					imgurl = href + data;
					console.log(imgurl);
					$(".img").attr("src", imgurl);
				}
			})
		})
		// 中文检测
		function isChineseChar(str) {
			var reg = /[\u4E00-\u9FA5\uF900-\uFA2D]/;
			return reg.test(str);
		}
		// 登录
		$("#btn_in").on("click", () => {
			if ($("#user_in").val() == "" || $("#pass_in").val() == "") {
				alert("密码或账号不能为空");
				return;
			} else if (isChineseChar($("#user_in").val()) || isChineseChar($("#pass_in").val())) {
				alert("密码和账号不能为中文");
				return;
			} else {
				$.ajax({
					url: href + "/in",
					type: "post",
					data: {
						user: $("#user_in").val(),
						pass: $("#pass_in").val(),
					},
					success(data) {

						if (data.length == 0) {
							alert('账号或密码错误');
							return;
						}
						location.reload();
						log.style.display = 'none';
						myimg.style.display = 'block';
						localStorage.user = JSON.stringify(data);
						alert(data.tip);
						$("#imgs").attr("src", data.img);
					}
				})
			}
		})
		// 注册
		$("#btn_up").on("click", () => {
			if ($("#user_up").val() == "" || $("#pass_up").val() == "" || $("#name_up").val() == "" || imgurl == "") {
				alert("密码或账号不能为空");
				return;
			} else if (isChineseChar($("#user_up").val()) || isChineseChar($("#pass_up").val())) {
				alert("密码和账号不能为中文");
				return;
			} else {
				$.ajax({
					url: href + "/up",
					type: "post",
					data: {
						name: $("#name_up").val(),
						user: $("#user_up").val(),
						pass: $("#pass_up").val(),
						userimg: imgurl
					},
					success(data) {
						alert(data);
					}
				})
			}
		})
		imgs.onclick = function () {
			$("#div").fadeIn(1000);
		}
		imgs.ondblclick = function () {
			$("#div").fadeOut(1000);
		}
		//退出登录
		btn_out.onclick = function () {
			localStorage.clear();
			location.href = "index.html";
			myimg.style.display = 'none';
			log.style.display = 'block';
		}
	</script>
</body>

</html>