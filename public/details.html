<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>details</title>
    <script src="./javascripts/jquery.min.js"></script>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style-type: none;
            user-select: none;
        }

        .L_cover {
            height: 200px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .L_cover-left {
            width: 140px;
            height: 170px;
            margin: 20px 20px 0 0;
            float: left;
        }

        .L_book-img {
            width: 100%;
            height: 100%;
        }

        .L_cover-center {
            float: left;
        }

        .L_author {
            color: #ccc;
        }

        .L_text {
            font-size: 14px;
            color: #ccc;
        }

        .L_cover-right {
            float: right;
        }

        #L_collect {
            width: 100px;
            height: 50px;
            margin-top: 20px;
            outline: none;
        }

        .L_chap {
            border-bottom: 1px solid #ccc;
        }

        .L_list li {
            height: 40px;
            line-height: 40px;
            font-size: 20px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            background-color: bisque;
        }

        .L_lb {
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        .tx {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: red;
            float: left;
            margin-right: 20px;
        }

        .top {
            height: 50px;
            text-align: center;
            line-height: 50px;
            font-size: 22px;
            border-bottom: 1px solid;
        }

        .back {
            width: 100px;
            height: 50px;
            float: left;
            outline: none;
            border-style: none;
            background: none;
            font-size: 45px;
        }
    </style>
</head>

<body>

    <!-- 头部 -->
    <div class="head" style="background:#dcdcdc4d;width: 100%;height: 70px;">
        <div class="container">
            <div class="logo" style="width: 100px;height: 70px;display: inline-block;">
                <img src="http://www.cnlogo8.com/d/file/2017-04-13/5a97b5fd70fa3a059e2ac9cc4a891989.png" alt="返回首页"
                    style="width: 100%;height: 100%;">
            </div>
            <!--登录注册-->
            <div id="log"
                style="float: right;width: 100px;height: 70px;line-height: 70px;text-align: center;font-size: 20px;">
                <span data-toggle="modal" data-target="#login" class="login">登录</span> /
                <span data-toggle="modal" data-target="#logup" class="logup">注册</span>
            </div>
            <!--头像-->
            <div id="myimg" style="float: right;width: 70px;height: 70px;display: none;position: relative;">
                <img src="https://ss1.baidu.com/9vo3dSag_xI4khGko9WTAnF6hhy/image/h%3D300/sign=ad628627aacc7cd9e52d32d909032104/32fa828ba61ea8d3fcd2e9ce9e0a304e241f5803.jpg"
                    alt="" id="imgs" style="width: 70px;height: 70px;border-radius: 50%;" />
                <div id="div"
                    style="width: 130px;height: 110px;background: #aaa;text-align: center;line-height: 30px;display: none;margin-left: -20px;position: absolute;left: 0;bottom: -110px;z-index: 10;">
                    <p style="border-bottom: 1px dotted #fff;">
                        <a href="booklist.html" style="text-decoration: none;color: #fff;">书架</a>
                    </p>
                    <p style="border-bottom: 1px dotted #fff;">
                        <a href="mymsg.html" style="text-decoration: none;color: #fff;">个人中心</a>
                    </p>
                    <p style="border-bottom: 1px dotted #fff; color: #fff;" id="btn_out">退出登录</p>
                </div>
            </div>

            <!--头像结束-->
        </div>
    </div>
    <!-- 头部结束 -->
    <!-- 内容 -->
    <div class="container" style="min-height:500px;border:1px solid red;">
        <div class="top"><button class="back glyphicon glyphicon-arrow-left"></button>个人中心</div>
        <!-- 封面 -->
        <div class='L_cover' style="overflow:hidden">
            <div class='L_cover-left'>
                <img class="L_book-img" src="">
            </div>
            <div class='L_cover-center'>
                <h3 class='L_title'></h3>
                <p class='L_author'></p>
                <p class='L_text'><span class="brie"></span><span class='L_look'>查看更多</span></p>
            </div>
            <!-- 收藏 -->
            <div class='L_cover-right'>
                <button id='L_collect'>收藏</button>
            </div>
        </div>
        <!-- 章节 -->
        <div class='L_chap'>
            <p style="height:25px;line-height:25px;font-size:20px">章节</p>
            <ul class='L_list'>
                <li>第一章：内容</li>
                <li>第一章：内容</li>
            </ul>
        </div>
        <!-- 评论 -->
        <div class='L_comment' style="margin-top:15px;">
            <div class='L_pl'>
                <input type="text" id="text" style="height:40px;width:90%" placeholder="输入评论内容">
                <button id="btn_pl" style="width:10%;height:40px;float:right;">评论</button>
            </div>
            <ul class="uls">
                                
            </ul>
        </div>
    </div>
    <!-- 内容结束 -->
    <!-- 尾部 -->
    <div class="foot"
        style="width: 100%;height:100px;background:#333;color: #fff;text-align: center;padding-top: 10px;">
        <div class="container">
            <p>海量图书，更高品质阅读体验</p>
            <p>网络文化经营许可证：粤网文[2017]3018-499号</p>
            <p>Designed and built with all the love in the world by @mdo and @fat. Maintained by the core team with the
                help of our contributors.</p>
        </div>
    </div>
    <!-- 尾部结束 -->
    <!--注册-->
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="logup">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">注册</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="img">头像
                            <input style="display:none;" type="file" class="files" id="img">
                            <div id="img"><img class="img" src="" alt=""></div>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="name">昵称</label>
                        <input type="text" class="form-control" id="name_up" placeholder="昵称">
                    </div>
                    <div class="form-group">
                        <label for="user">账号</label>
                        <input type="text" class="form-control" id="user_up" placeholder="账号">
                    </div>
                    <div class="form-group">
                        <label for="pass">密码</label>
                        <input type="password" class="form-control" id="pass_up" placeholder="密码">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="btn_up">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!--结束-->
    <!--登录-->
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="login">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">登录</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <label for="user">账号</label>
                        <input type="text" class="form-control" id="user_in" placeholder="账号">
                    </div>
                    <div class="form-group">
                        <label for="pass">密码</label>
                        <input type="password" class="form-control" id="pass_in" placeholder="密码">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="btn_in">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!--结束-->
</body>
<script>
    // 收藏
    $('#L_collect').on('click', function () {
       
        if (!localStorage.user) {
            // console.log(localStorage.user);
            alert('请先登录');
            return;
        } else {
            $.ajax({
                url: href + '/collect',
                type: 'post',
                data: {
                    name: JSON.parse(localStorage.bookmsg).name,
                    auth: JSON.parse(localStorage.bookmsg).author,
                    bookimg: JSON.parse(localStorage.bookmsg).bookimg,
                    logid: JSON.parse(localStorage.user).uid,
                    bookid: JSON.parse(localStorage.bookmsg).uid
                },
                success(data) {

                    if (data == '此书已收藏') {
                        $('#L_collect').text('已收藏');
                        $('#L_collect').attr('disabled', 'true');
                        alert(data);
                    } else {
                        $('#L_collect').text('已收藏');
                        $('#L_collect').attr('disabled', 'true');
                        alert(data);
                    }

                }
            })
        }

    })
    //获取登录状态
    if (localStorage.user) {
        // console.log(123);
        var json = JSON.parse(localStorage.user);
        $("#imgs").attr("src", json.img);
        log.style.display = 'none';
        myimg.style.display = 'block';
    }
    if (localStorage.user == "" || localStorage.bookmsg == "") {
        alert("当前没有书籍信息,即将返回首页");
        location.href = "index.html";
    }
    var href = 'http://192.168.43.239:8000';
    if (localStorage.bookmsg) {
        var json = JSON.parse(localStorage.bookmsg);
        $(".L_title").html(json.name);
        $(".L_book-img").attr('src', json.bookimg);
        $(".L_author").html(json.author);
        // $(".L_nc").text(json.briefing);
        $('.brie').text(json.briefing);

        $.ajax({
            url: href + '/bookid',
            type: 'post',
            data: {
                bookid: json.uid
            },
            success(data) {
                chaplist(data);
            }
        })
        uls(json.uid);
    }
    function uls(uid) {
        $.ajax({
            url: href + '/pload',
            type: 'get',
            data: {
                pl: uid
            },
            success(data) {
                $('.uls').empty();
                $.each(data, function (i, o) {
                    var li = $(`<li class='L_lb' style="overflow:hidden">
    						<img src="${o.img}" class='tx'>
    						<div class='left' style="float:left;">
    							<h3 class='L_bt'>${o.user}</h3>
    							<p class='L_intro'>${o.text_pl}</p>
    						</div>
    					</li>
    				`)
                    $('.uls').append(li);
                })

            }
        })
    }
    // 刷新章节
    var chaps = null, contents = null;
    function chaplist(data) {
        $('.L_list').empty();
        $.each(data, function (i, o) {
            var li = $(`<li>${o.name}</li>`)
            $('.L_list').append(li);
            $(li).on("click", function () {
                // console.log($(this).index())
                localStorage.read = JSON.stringify(data[$(this).index()]);
                location.href = "readbook.html";
            })
        })
    }
    //评论
    $('#btn_pl').on('click', function () {
        var user = JSON.parse(localStorage.user);
        var book = JSON.parse(localStorage.bookmsg);
        $.ajax({
            type: 'post',
            url: href + '/insert',
            data: {
                user: user.user,
                img: user.img,
                bookid: book.uid,
                pltext: $('#text').val()
            },
            success(data) {
                $('.uls').empty();
                console.log(data);
                $.each(data, function (i, o) {
                    var li = $(`<li class='L_lb' style="overflow:hidden">
								<img src="${o.img}" class='tx'>
								<div class='left' style="float:left;">
									<h3 class='L_bt'>${o.user}</h3>
									<p class='L_intro'>${o.text_pl}</p>
								</div>
							</li>`)
                    $('.uls').append(li)
                })
                $('#text').val('');
            }
        })
    })
    //头像
    var imgurl = '';
    $(".files").on("change", function () {
        var files = $(this)[0].files[0];
        var d = new FormData;
        d.append("tx", files);
        $.ajax({
            url: href + "/cover/cover",
            type: "post",
            data: d,
            contentType: false,
            processData: false,
            success(data) {
                imgurl = href + data;
                console.log(imgurl);
                $(".img").attr("src", imgurl);
            }
        })
    })
    // 中文检测
    function isChineseChar(str) {
        var reg = /[\u4E00-\u9FA5\uF900-\uFA2D]/;
        return reg.test(str);
    }
    // 登录
    $("#btn_in").on("click", () => {
        if ($("#user_in").val() == "" || $("#pass_in").val() == "") {
            alert("密码或账号不能为空");
            return;
        } else if (isChineseChar($("#user_in").val()) || isChineseChar($("#pass_in").val())) {
            alert("密码和账号不能为中文");
            return;
        } else {
            $.ajax({
                url: href + "/in",
                type: "post",
                data: {
                    user: $("#user_in").val(),
                    pass: $("#pass_in").val(),
                },
                success(data) {
                    if (data.length == 0) {
                        alert('账号或密码错误');
                        return;
                    }
                    log.style.display = 'none';
                    myimg.style.display = 'block';
                    localStorage.user = JSON.stringify(data);
                    alert(data.tip);
                    $("#imgs").attr("src", data.img);
                }
            })
        }
    })
    // 注册
    $("#btn_up").on("click", () => {
        if ($("#user_up").val() == "" || $("#pass_up").val() == "" || $("#name_up").val() == "" || imgurl == "") {
            alert("密码或账号不能为空");
            return;
        } else if (isChineseChar($("#user_up").val()) || isChineseChar($("#pass_up").val())) {
            alert("密码和账号不能为中文");
            return;
        } else {
            $.ajax({
                url: href + "/up",
                type: "post",
                data: {
                    name: $("#name_up").val(),
                    user: $("#user_up").val(),
                    pass: $("#pass_up").val(),
                    userimg: imgurl
                },
                success(data) {
                    alert(data);
                }
            })
        }
    })
    imgs.onclick = function () {
        $("#div").fadeIn(1000);
    }
    imgs.ondblclick = function () {
        $("#div").fadeOut(1000);
    }
    //退出登录
    btn_out.onclick = function () {
        localStorage.user='';
        myimg.style.display = 'none';
        log.style.display = 'block';
    }
    //返回首页
    $('.logo').on('click', function () {
        location.href = 'index.html';
    })
    //返回
    $('.back').on('click', function () {
        location.href = 'index.html';
    })
</script>

</html>