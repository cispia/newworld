<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>书架列表</title>
	<script src="./javascripts/jquery.min.js"></script>
	<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			list-style: none;
			user-select: none;
		}

		.booklist,
		.bookhistory {
			width: 100%;
			min-height: 200px;
			/* background-color: orange; */
			padding-bottom: 10px;
			border: 2px solid green;
			margin-bottom: 5px;
		}

		.booklist h3,
		.bookhistory h3 {
			height: 30px;
			line-height: 30px;
			padding-left: 15px;
		}

		.list_ul,
		.history_ul {
			width: 100%;
			height: 300px;
			border-top: 2px solid;
		}

		.list_ul li,
		.history_ul li {
			width: 20%;
			float: left;
			margin: 10px 15px;
			border: 1px solid;
		}

		.bookimg {
			width: 100%;
			height: 230px;
		}

		.bookimg img {
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body>

	<!-- 头部 -->
	<div class="head" style="background:#dcdcdc4d;width: 100%;height: 70px;">
		<div class="container">
			<div class="logo" style="width: 100px;height: 70px;display: inline-block;">
				<img src="http://www.cnlogo8.com/d/file/2017-04-13/5a97b5fd70fa3a059e2ac9cc4a891989.png" alt="返回首页" style="width: 100%;height: 100%;">
			</div>
			<!--登录注册-->
			<div id="log"
				style="float: right;width: 100px;height: 70px;line-height: 70px;text-align: center;font-size: 20px;">
				<span data-toggle="modal" data-target="#login" class="login">登录</span> /
				<span data-toggle="modal" data-target="#logup" class="logup">注册</span>
			</div>
			<!--头像-->
			<div id="myimg" style="float: right;width: 70px;height: 70px;display: none;position: relative;">
				<img src="https://ss1.baidu.com/9vo3dSag_xI4khGko9WTAnF6hhy/image/h%3D300/sign=ad628627aacc7cd9e52d32d909032104/32fa828ba61ea8d3fcd2e9ce9e0a304e241f5803.jpg"
					alt="" id="imgs" style="width: 70px;height: 70px;border-radius: 50%;" />
				<div id="div"
					style="width: 130px;height: 110px;background: #aaa;text-align: center;line-height: 30px;display: none;margin-left: -20px;position: absolute;left:0;bottom: -110px;z-index: 10;">
					<p style="border-bottom: 1px dotted #fff;">
						<a href="booklist.html" style="text-decoration: none;color: #fff;">书架</a>
					</p>
					<p style="border-bottom: 1px dotted #fff;">
						<a href="mymsg.html" style="text-decoration: none;color: #fff;">个人中心</a>
					</p>
					<p style="border-bottom: 1px dotted #fff; color: #fff;" id="btn_out">退出登录</p>
				</div>
			</div>

			<!--头像结束-->
		</div>
	</div>
	<!-- 头部结束 -->
	<!-- 内容 -->
	<div class="container" style="min-height:500px;border:1px solid;">
		<!-- 书架列表 -->
		<div class="booklist" style="margin-top: 10px;">
			<div class="booklist_title" style="position: relative;">
				<h3>我的书架</h3>
				<span class="glyphicon glyphicon-trash remove"
					style="position: absolute;top:0px;right:30px;font-size: 25px;"></span>
			</div>
			<ul class="list_ul">

			</ul>
		</div>
	</div>
	<!-- 内容结束 -->
	<!-- 尾部 -->
	<div class="foot"
		style="width: 100%;height:100px;background:#333;color: #fff;text-align: center;padding-top: 10px;">
		<div class="container">
			<p>海量图书，更高品质阅读体验</p>
			<p>网络文化经营许可证：粤网文[2017]3018-499号</p>
			<p>Designed and built with all the love in the world by @mdo and @fat. Maintained by the core team with the
				help of our contributors.</p>
		</div>
	</div>
	<!-- 尾部结束 -->
	<!--注册-->
	<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="logup">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">注册</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="img">头像
							<input style="display:none;" type="file" class="files" id="img">
							<div id="img"><img class="img" src="" alt=""></div>
						</label>
					</div>
					<div class="form-group">
						<label for="name">昵称</label>
						<input type="text" class="form-control" id="name_up" placeholder="昵称">
					</div>
					<div class="form-group">
						<label for="user">账号</label>
						<input type="text" class="form-control" id="user_up" placeholder="账号">
					</div>
					<div class="form-group">
						<label for="pass">密码</label>
						<input type="password" class="form-control" id="pass_up" placeholder="密码">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="btn_up">确定</button>
				</div>
			</div>
		</div>
	</div>
	<!--结束-->
	<!--登录-->
	<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="login">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
							aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">登录</h4>
				</div>
				<div class="modal-body">

					<div class="form-group">
						<label for="user">账号</label>
						<input type="text" class="form-control" id="user_in" placeholder="账号">
					</div>
					<div class="form-group">
						<label for="pass">密码</label>
						<input type="password" class="form-control" id="pass_in" placeholder="密码">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="btn_in">确定</button>
				</div>
			</div>
		</div>
	</div>
	<!--结束-->
	<script>
		var href = 'http://192.168.43.239:8000';
		//获取登录状态
		if (localStorage.user) {
			// console.log(123);
			var json = JSON.parse(localStorage.user);
			$("#imgs").attr("src", json.img);
			log.style.display = 'none';
			myimg.style.display = 'block';
			collection(JSON.parse(localStorage.user).uid);
		}
		if (localStorage.user == "") {
			alert("当前没有书籍信息,即将返回首页");
			location.href = "index.html";
		}
		function collection(uid) {
			// 书架收藏
			$.ajax({
				url: href + '/booklist',
				type: 'get',
				data: {
					logid: uid
				},
				success(data) {
					$('.list_ul').empty();
					if(data.length==0){
						$('.list_ul').text('您还没有收藏');
					}
					$.each(data, function (i, o) {
						var li = $(`
						<li style="position: relative;">
								<span class="glyphicon glyphicon-remove-sign b_remove" style="position: absolute;top:-5px;right:-5px;font-size:20px;color:red;display: none;"></span>
								<a href="details.html" style="text-decoration: none">
						<div class="bookimg">
							<img src="${o.bookimg}" alt="">
						</div>
						<div class="bookauthor">
							<span style="color: #000;display:block;width: 100%;height: 25px;line-height: 25px;font-size: 15px;padding: 0 20px;">《${o.name}》</span>
							<span style="color: #a3a3a3;display:block;width: 100%;height: 25px;line-height: 25px;font-size: 15px;padding: 0 20px;">&nbsp;&nbsp;${o.author}</span>
						</div>
						</a>
					</li>
						`)
						$('.list_ul').append(li);
						$(li).on('click',function(){
						localStorage.bookmsg=JSON.stringify(data[$(this).index()]);
					})
					})
					// 删除收藏
					$('.b_remove').on('click', function () {
						console.log($(this).parent().index());
						$.ajax({
							url: href + '/delcol',
							type: 'get',
							data: {
								logid: data[$(this).parent().index()].uid
							},
							success(data) {
								collection(JSON.parse(localStorage.user).uid);
							}
						})
					})

				}
			})
		}
		$('.remove').on('click', function () {
			if ($('.b_remove').css("display")=="block") {
				$('.b_remove').css({
					display: 'none',
				})
			} else {
				$('.b_remove').css({
					display: 'block',
				})
			}
		})
		//头像
		var imgurl = '';
		$(".files").on("change", function () {
			var files = $(this)[0].files[0];
			var d = new FormData;
			d.append("tx", files);
			$.ajax({
				url: href + "/cover/cover",
				type: "post",
				data: d,
				contentType: false,
				processData: false,
				success(data) {
					imgurl = href + data;
					console.log(imgurl);
					$(".img").attr("src", imgurl);
				}
			})
		})
		// 中文检测
		function isChineseChar(str) {
			var reg = /[\u4E00-\u9FA5\uF900-\uFA2D]/;
			return reg.test(str);
		}
		// 登录
		$("#btn_in").on("click", () => {
			if ($("#user_in").val() == "" || $("#pass_in").val() == "") {
				alert("密码或账号不能为空");
				return;
			} else if (isChineseChar($("#user_in").val()) || isChineseChar($("#pass_in").val())) {
				alert("密码和账号不能为中文");
				return;
			} else {
				$.ajax({
					url: href + "/in",
					type: "post",
					data: {
						user: $("#user_in").val(),
						pass: $("#pass_in").val(),
					},
					success(data) {
						if (data.length == 0) {
							alert('账号或密码错误');
							return;
						}
						log.style.display = 'none';
						myimg.style.display = 'block';
						localStorage.user = JSON.stringify(data);
						alert(data.tip);
						$("#imgs").attr("src", data.img);
					}
				})
			}
		})
		// 注册
		$("#btn_up").on("click", () => {
			if ($("#user_up").val() == "" || $("#pass_up").val() == "" || $("#name_up").val() == "" || imgurl == "") {
				alert("密码或账号不能为空");
				return;
			} else if (isChineseChar($("#user_up").val()) || isChineseChar($("#pass_up").val())) {
				alert("密码和账号不能为中文");
				return;
			} else {
				$.ajax({
					url: href + "/up",
					type: "post",
					data: {
						name: $("#name_up").val(),
						user: $("#user_up").val(),
						pass: $("#pass_up").val(),
						userimg: imgurl
					},
					success(data) {
						alert(data);
					}
				})
			}
		})
		imgs.onclick = function () {
			$("#div").fadeIn(1000);
		}
		imgs.ondblclick = function () {
			$("#div").fadeOut(1000);
		}
		//退出登录
		btn_out.onclick = function () {
			localStorage.clear();
			myimg.style.display = 'none';
			log.style.display = 'block';
		}
		$('.logo').on('click',function(){
			location.href='index.html';
		})
	</script>
</body>

</html>